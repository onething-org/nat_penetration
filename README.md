#### 两个处于不同内网的机器通过 TCP/IP 协议进行通讯

假设我们有两台处于不同内网的两台机器 A 和 B 以及一台众所周知外网 IP 的服务器 S，机器 A 中运行着通讯的服务端程序，B 运行着通讯的客户端程序，那么

1. A 连接 S，S 记录 A 的外网 IP 与通讯端口
2. B 连接 S
3. S 将 A 与此通讯的端口号返回给 A
4. S 将 A 与此连接的 IP 与端口号返回给 B
5. A 在程序中将服务绑定并侦听在从 S 返回的端口
6. B 使用从 S 返回的 IP 与端口连接 A

这样A与B就成功连接了

*需要注意的是两个 socket 在同一个端口绑定的问题，socket 提供了 setsockopt 函数，其中参数 SO_REUSEADDR 可以解决这个问题*



UDP打洞的方法就是两台处于不同内网的机器向一个众所周知的固定的外网发送包，然后该外网分别向两台内网机器发送对方与该外网链接的外网ip地址 与端口，最后两台内网机器进行通讯。假如我们的两台处于不同内网的机器分别为A(192.168.1.10)和B(192.168.1.10)，它们的网 关分别为C1(123.123.123.123)和C2(234.234.234.234)，众所周知的外网服务器为 S(111.111.111.111)，那么就是这样的

A(192.168.1.10:1234)—>C1(123.123.123.123:2345)—>S(111.111.111.1111:8888)
B(192.168.1.10:2134)—>C2(234.234.234.234:2314)—>S(111.111.111.111:8888)
S(111.111.111.111:8888)—>C1(123.123.123.123:2345)—>A(192.168.1.10:1234)
S(111.111.111.111:8888)—>C2(234.234.234.234:2314)—>B(192.168.1.10:2134)
B(192.168.1.10:2134)—>C2(234.234.234.234:2314)—>C1(123.123.123.123:2345)—>A(192.168.1.10:1234)
A(192.168.1.10:1234)—>C1(123.123.123.123:2345)—>C2(234.234.234.234:2314)—>B(192.168.1.10:2134)

A与S连接时在C1上打了个洞，B与S连接时在C2上打了个洞，我们只要知道这两个洞就可以相互发送数据了